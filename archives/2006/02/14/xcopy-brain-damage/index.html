<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>girtby.net &#8211;   xcopy brain damage</title>

<meta name="verify-v1" content="unGvQ7Jwj5liZb2PzH2ckduvpe8Ua3Ls0MONzCHQQn4=" />

<link rel="stylesheet" href="http://girtby.net/wp-content/themes/depo-clean/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Articles Feed" href="http://girtby.net/feed/atom/" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Comments Feed" href="http://girtby.net/comments/feed/atom/" />

<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://arankine.myopenid.com/" />

<link rel="meta" href="http://girtby.net/labels.rdf" type="application/rdf+xml" title="ICRA labels" />
<meta http-equiv="pics-Label" content='(pics-1.1 "http://www.icra.org/pics/vocabularyv03/" l gen true for "http://girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1) gen true for "http://www.girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1))' />

<link rel="prev" href="http://girtby.net/archives/2006/02/10/a-futile-gesture/" />
<link rel="next" href="http://girtby.net/archives/2006/02/18/rethinking-virus-protection/" />

<link rel="pingback" href="http://girtby.net/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Feed" href="http://girtby.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Comments Feed" href="http://girtby.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; xcopy brain damage Comments Feed" href="http://girtby.net/archives/2006/02/14/xcopy-brain-damage/feed/" />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>
<script type='text/javascript' src='http://girtby.net/wp-content/themes/depo-clean/javascript/friendly_dates.js?ver=2.9-rare'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://girtby.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://girtby.net/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='girtby.net' href='http://girtby.net' />
<link rel='start' title='Thunderbirds Are Go-ne' href='http://girtby.net/archives/2004/09/20/thunderbirds-are-go-ne/' />
<link rel='prev' title='A Futile Gesture' href='http://girtby.net/archives/2006/02/10/a-futile-gesture/' />
<link rel='next' title='Rethinking Virus Protection' href='http://girtby.net/archives/2006/02/18/rethinking-virus-protection/' />
<meta name="generator" content="WordPress 2.9-rare" />
<link rel='canonical' href='http://girtby.net/archives/2006/02/14/xcopy-brain-damage/' />
			<script type="text/javascript" src="http://girtby.net/wp-content/plugins/flickr-tag/js/flickrTagTooltips.js"></script>

			<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTagTooltips.css" type="text/css" rel="stylesheet"/>
	
		<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTag.css" type="text/css" rel="stylesheet"/>
	</head>
<body>
<div class="container">
	<div class="header">
        <div class="search">
            <form method="get" id="sform" action="http://girtby.net/">
                <input type="text" id="q" value="" name="s" size="15" />
			</form>
        </div><!-- end search -->
        			        <h1><a href="http://girtby.net/">this blog is girtby.net</a> 
            </h1>
	</div><!-- end header -->


<div class="blogads">

<!-- Your Stuff Here -->

</div>


    						
      <div class="post">
          <div class="metainfo">
              <p>Posted<br />
                <abbr class="published" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr></p>
                <p>Tagged<br />
                <a href="http://girtby.net/archives/category/nerd-factor-x/" title="View all posts in Nerd Factor X" rel="category tag">Nerd Factor X</a>,  <a href="http://girtby.net/archives/category/provocation/" title="View all posts in Provocation" rel="category tag">Provocation</a></p>
                		    </div>
		    <div class="content">
		        <h3>xcopy brain damage 
		        </h3>
		        <p>And now, a software development war story, if you&#8217;ll indulge me.</p>

<p><span id="more-174"></span></p>

<h4>The Problem</h4>

<p>Once upon a time I worked on a project where one of the deliverables was a Windows executable. We had a <code>build.bat</code> batch file with commands to copy executables and libraries from the build directories into a <code>bin</code> directory so they can be run.</p>

<p>The initial version of this used the vanilla Windows <code>copy</code> command. However this always copies every single file to the <code>bin</code> directory, resulting in a small, but noticable, turnaround time between building the executable and running it.</p>

<p>I thought: surely it would be easy to only copy the files if they had actually changed? Most of the files were third-party DLLs and they never change.</p>

<h4>Attempt #1: <code>nmake</code></h4>

<p>I initially looked at using a makefile for this, more specifically the <code>nmake</code> tool that comes with Visual C++. After wrangling this tool for a bit, and eventually realising that it implements maybe 10% of the functionality of a real make tool (eg GNU make), I gave up. Not only was the makefile a monster (the equivalent in GNU make would be about 2 lines), but also it didn&#8217;t quite do what I wanted. The existing build script ignores executables which haven&#8217;t been built yet (e.g. test harnesses for modules you&#8217;re not working on), and it was too hard to get <code>nmake</code> to do this.</p>

<p>Why not just use GNU make? Well as a general principle I try not to introduce additional dependencies on the build system unless absolutely necessary. I had one other alternative that was available for free&#8230;</p>

<h4>Attempt #2: <code>xcopy</code></h4>

<p>So the next step was to modify <code>build.bat</code> to use <code>xcopy</code>. This tool has a <code>\d</code> option which (according to the help) &#8220;Copies files changed on or after the specified date. If no date is given, copies only those files whose source time is newer than the destination time.&#8221; Sounds just the ticket right?</p>

<p>Unfortunately this option is so broken that I wonder if anyone has ever managed to put it to any worthwhile use, ever.</p>

<p>Note that it says it compares the source time with the destination time. Unfortunately if you specify the destination as a directory it will use the timestamp of the directory as the comparison, even if the source is a file. Duh.</p>

<h4>Attempt #3: <code>xcopy</code>, again</h4>

<p>OK, so we just specify the destination as a full filename, such as <code>xcopy \d build\blah\foo.exe bin\foo.exe</code>, right? Nope, Microsoft strikes again! <code>xcopy</code> gets confused and prompts you as to whether the destination is a directory or a file (!) As Dave Barry says, I am not making this up:</p>

<pre><code>Does c:\path\to\bin\foo.exe specify a file name or directory name
on the target (F = file, D = directory)?
</code></pre>

<p>And of course there is no option to tell it which, beforehand.</p>

<p>After being struck with stupidity of such awesome magnitude, I simply gave up and went back to just blindly copying everything every time. And I can&#8217;t recall ever having used <code>xcopy</code> since then.</p>
		        <br clear="left" />
		    </div>
        </div><!-- end post -->

			
<!-- You can start editing here. -->


<div id="comments" class="post">

	<h3 class="comments_headers">13 Comments</h3>

</div>
	
	
			
        <div class="post" id="comment-1344">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://cardboard.nu' rel='external nofollow' class='url'>Alan Green</a><br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1344">#</a></p>
			</div>
			<div class="content">
				<p>Your story illustrates why Windows programmers are paid more than Unix programmers: danger money.</p>

<p>As an alternative to introducing GNU make, <a href="http://unxutils.sourceforge.net/" rel="nofollow">http://unxutils.sourceforge.net/</a> has a Windows version of the Unix &#8220;cp&#8221;. &#8220;cp -u srcfile destfile&#8221; will do what you want.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1345">
		    <div class="metainfo">
                <p>Posted by<br />marxy<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1345">#</a></p>
			</div>
			<div class="content">
				<p>If you&#8217;re going to install stuff then I&#8217;d install cygwin and rsync which will do what you want.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1346">
		    <div class="metainfo">
                <p>Posted by<br />alastair<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1346">#</a></p>
			</div>
			<div class="content">
				<p>As I recall, we did eventually introduce a dependency on Cygwin. It just seems like such a simple task that you&#8217;d think Windows would be able to do it out of the box. I guess not?</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1347">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://www.deadlybloodyserious.com/' rel='external nofollow' class='url'>Garth</a><br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1347">#</a></p>
			</div>
			<div class="content">
				<p>Yuck: </p>

<p>echo F | xcopy /d build\blah\foo.exe bin\foo.exe</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1348">
		    <div class="metainfo">
                <p>Posted by<br />marcus<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1348">#</a></p>
			</div>
			<div class="content">
				<p>I tried:</p>

<p>system(&#8220;echo xcopy \&#8221;$returnstr\&#8221; \&#8221;$mez<em>test</em>str\&#8221; /f /s /e /i&#8221;);</p>

<p>nothing happens, but it is asking me </p>

<p>Does C:\build\6.2.3\noncompiled\Release6.2\InStorecard\Web\Assets\buysafe\shopper\ttlHd_crdts.gif specify a file name
or directory name on the target
(F = file, D = directory)?</p>

<p>i tired:</p>

<p>system(&#8220;echo F|xcopy \&#8221;$returnstr\&#8221; \&#8221;$mez<em>test</em>str\&#8221; /f /s /e /i&#8221;);</p>

<p>and I get a parse error on the F|.</p>

<p>Not sure what to do now. using XPerl</p>

<p>Does anyone know what to do. This is under cygwin as well.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1349">
		    <div class="metainfo">
                <p>Posted by<br />Jim<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1349">#</a></p>
			</div>
			<div class="content">
				<p>Try not using &#8220;\&#8221; at the end of the source path and adding one at the end of the destination. Something like this: </p>

<p>C:\temp&gt;xcopy d:\h-drive\caching-cdn-proxy-streaming\ h:\caching-cdn-proxy-streaming\ /t /e</p>

<p>or maybe like xcopy drive:\path*.exe \drive:\path\ /various parameters.</p>

<p>also, if you copy xcopy.exe to mcopy.exe, it changes how it works. The difference I found is that mcopy requires that the destination path exist, where xcopy will create it if you answer the file or directory question interactively.</p>

<p>Good Luck. Let me know if it works.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1350">
		    <div class="metainfo">
                <p>Posted by<br />me<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1350">#</a></p>
			</div>
			<div class="content">
				<p>I&#8217;ve used and I am still using XCOPY a lot of times, and I never had any issue with it, whatsoever. I only use it to refresh directory structures (/s), never without this option, never to copy 1 file. I&#8217;ve checked it multiple times, and it works perfectly, I am 100% sure that it works, using this method :</p>

<p>xcopy C:\something&#42;.* D:\backup /s /d /y</p>

<p>The issue as described in Attempt#3 is indeed annoying, but I guess that the /d option makes this go away, as this way he knows what he is copying, and doesn&#8217;t come and asks this silly question.</p>

<p>The issue as you described in Attempt2, I have never seen. I assume it appears when not using &#8220;<em>.</em>&#8220;, or when not using &#8220;/s&#8221;, but I am guessing. The timestamp comparision system works all right, I have seen it do time and time again, it is reliable as nothing else. I use it for incremental backups.</p>

<p>Problem is, but that is not xcopy&#8217;s fault, is that if you use it for incremental backup purposes (for which this /d option is designed anyway), is that removed files/directories on the source, still appear on the target. Depending on the circumstances, this may be a problem.</p>

<p>Regards</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1351">
		    <div class="metainfo">
                <p>Posted by<br />FTR<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1351">#</a></p>
			</div>
			<div class="content">
				<p>Try</p>

<p>xcopy \d build\blah\foo.exe bin\</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1352">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1352">#</a></p>
			</div>
			<div class="content">
				<p>So here&#8217;s the test case for those of you that want to have a try:</p>

<pre><code>C:\temp&gt;mkdir bin

C:\temp&gt;mkdir build

C:\temp&gt;mkdir build\blah

C:\temp&gt;echo hello &gt; build\blah\foo.txt
</code></pre>

<p>Now your task is to find an xcopy command that will copy <code>build\blah\foo.txt</code> to <code>bin\foo.txt</code> but only when the former changes. In other words it should copy the first time, and subsequently not copy the file. Then, if you change <code>build\blah\foo.txt</code>it should copy the file the first time and not after that. Make sense?</p>

<p>@me:</p>

<p>The <code>\d</code> option is the whole point of the exercise. Without it I go back to copying everything all the time, and I can just use copy for that.</p>

<p>@FTR:</p>

<pre><code>C:\temp&gt;xcopy \d build\blah\foo.txt bin\
Invalid number of parameters
</code></pre>

<p>Thanks for playing.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1353">
		    <div class="metainfo">
                <p>Posted by<br />Richard<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1353">#</a></p>
			</div>
			<div class="content">
				<p>Try using the slash the right way around. DOS options use leading /&#8217;s, not \&#8217;s or -&#8217;s.</p>

<pre><code>C:\temp&gt;xcopy /d build\blah\foo.txt bin\
build\blah\foo.txt
1 File(s) copied
</code></pre> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1354">
		    <div class="metainfo">
                <p>Posted by<br />Goitom<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1354">#</a></p>
			</div>
			<div class="content">
				<p>I am refering to the problem mentioned at the begining of the thread for &#8220;Attempt #3: xcopy, again&#8221;, this might be a solution to just copy only the file without being prompted to choose either file or directory</p>

<p>xcopy /f /s /y build\blah\foo.exe bin\</p>

<p>Thanks,</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1355">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://www.evolvit.co.uk/' rel='external nofollow' class='url'>Matt Winchester</a><br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1355">#</a></p>
			</div>
			<div class="content">
				<p>I am experiencing the same problem. The answer to your test case is to use the /m option instead of the /d option. That way it will copy the file the first time, then reset the archive flag for that file. it will then not copy that file again until you modify it, causing the archive flag to be set again.</p>

<p>That is no good in my situation though as I am trying to back up to a removable tape drive, and I need the file to be copied to each tape, not just the first tape that is inserted after the file was modified.</p>

<p>Does anyone know why the /d option doesn&#8217;t do what it is supposed to?</p>

<p>Matt</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1356">
		    <div class="metainfo">
                <p>Posted by<br />Zarko<br />
                <input type="hidden" name="post_date" value="Tue, 14 Feb 2006 23:54:23 -0500" />
                <abbr class="commented" title="Tue, 14 Feb 2006 23:54:23 -0500">14 February 2006 @ 11pm</abbr><br />
                <a href="#comment-1356">#</a></p>
			</div>
			<div class="content">
				<p>Can this be the OS/version issue. I just tried on 2k3 (cmd/xcopy.exe ver: 5.02.3790.1830) with dest folder having the timestamp  lower but the file having higher then the source file and no problems at all:</p>

<p>02/19/2007  18:29    <dir>          bin
02/19/2007  18:33    </dir><dir>          build</dir></p>

<p>Directory of C:\E\temp\bin
02/19/2007  18:34                 8 foo.txt</p>

<p>Directory of C:\E\temp\build\blah
02/19/2007  18:30                 8 foo.txt</p>

<p>xcopy /I/Y/R/d build\blah\foo.txt bin\
0 File(s) copied</p>

<p>Tried several times, making bigger time diff (just in case) and never ever got a hiccup.</p>

<p>If we are still talking about building and on Windows, then you may want to take a look at the Rotor source distro (<a href="http://msdn.microsoft.com/net/sscli" rel="nofollow">http://msdn.microsoft.com/net/sscli</a>). Has the full build setup from DDK and a few extras (yes MS builds with Perl <img src='http://girtby.net/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /> . Then look for publish.pl (pcopy&#8221; and makefile.plt (PUBLISH_CMD=). The mention of &#8220;pcopy&#8221; in publish.pl is the place to add extra tests.</p> 
							</div>
		<br clear="left" />
		</div>
		
	

	<!-- Comment Form -->

	    

			
				
<div class="posttopline">
	<span class="previous">&larr; <a href="http://girtby.net/archives/2006/02/10/a-futile-gesture/" rel="prev">A Futile Gesture</a></span>
	<span class="next"><a href="http://girtby.net/archives/2006/02/18/rethinking-virus-protection/" rel="next">Rethinking Virus Protection</a> &rarr;</span>
</div>

<br clear="all" />

    <div class="footer">
		
        <div class="first">
        <div id="text-318154731" class="widget widget_text"><h5 class="widgettitle">Archives</h5>			<div class="textwidget"><ul>
<li><a href="/archives/2009">2009</a></li>
<li><a href="/archives/2008">2008</a></li>
<li><a href="/archives/2007">2007</a></li>
<li><a href="/archives/2006">2006</a></li>
<li><a href="/archives/2005">2005</a></li>
<li><a href="/archives/2004">2004</a></li>
</ul></div>
		</div>		</div>

        <div class="sidebar">
        <div id="text-326846052" class="widget widget_text"><h5 class="widgettitle">Leveraged Synergy</h5>			<div class="textwidget"><p>Hello, I&#8217;m Alastair Rankine. I once had a blog, and you've found it. <a href="/about/">Would you like to know more?</a></p>
<p>From time to time I made offerings to the internet. <a href="/offerings/">Would you like some?</a></p>
</div>
		</div>        </div>

        <div class="last">
        <div id="linkcat-2" class="widget widget_links"><h5 class="widgettitle">Blogroll</h5>
	<ul class='xoxo blogroll'>
<li><a href="http://bjkeefe.blogspot.com">bjkeefe</a></li>
<li><a href="http://brainsnorkel.com">brainsnorkel</a></li>
<li><a href="http://deadlybloodyserious.com">Deadly Bloody Serious</a></li>
<li><a href="http://blog.alphajuliet.com/">follicle</a></li>
<li><a href="http://madbean.com/">madbean</a></li>
<li><a href="http://marxyblog.blogspot.com">marxy&#8217;s musing on technology</a></li>
<li><a href="http://mattrubinstein.com.au">mattrubinstein.com.au</a></li>
<li><a href="http://somethinkodd.com/oddthinking">OddThinking</a></li>

	</ul>
</div>
        </div>

	    </div><!-- end footer -->

        <br clear="all" />
        
		<div class="copyright">
        	        	<span class="previous">&larr; <a href="http://girtby.net">Back to Home</a></span>
                        <p>Powered by <a href="http://wordpress.org">WordPress</a> using the <a href="http://powazek.com/posts/516">DePo Clean Theme</a> <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/au/"><img alt="Creative Commons License" class="badge" width=80 height=15 src="http://i.creativecommons.org/l/by-sa/2.5/au/80x15.png" /></a></p>
            		</div>

	</div> <!-- end container -->
</body>
</html>
