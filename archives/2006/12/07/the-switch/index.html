<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>girtby.net &#8211;   The Switch</title>

<meta name="verify-v1" content="unGvQ7Jwj5liZb2PzH2ckduvpe8Ua3Ls0MONzCHQQn4=" />

<link rel="stylesheet" href="http://girtby.net/wp-content/themes/depo-clean/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Articles Feed" href="http://girtby.net/feed/atom/" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Comments Feed" href="http://girtby.net/comments/feed/atom/" />

<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://arankine.myopenid.com/" />

<link rel="meta" href="http://girtby.net/labels.rdf" type="application/rdf+xml" title="ICRA labels" />
<meta http-equiv="pics-Label" content='(pics-1.1 "http://www.icra.org/pics/vocabularyv03/" l gen true for "http://girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1) gen true for "http://www.girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1))' />

<link rel="prev" href="http://girtby.net/archives/2006/12/04/trackback-attack/" />
<link rel="next" href="http://girtby.net/archives/2006/12/17/easing-into-ubuntu/" />

<link rel="pingback" href="http://girtby.net/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Feed" href="http://girtby.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Comments Feed" href="http://girtby.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; The Switch Comments Feed" href="http://girtby.net/archives/2006/12/07/the-switch/feed/" />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>
<script type='text/javascript' src='http://girtby.net/wp-content/themes/depo-clean/javascript/friendly_dates.js?ver=2.9-rare'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://girtby.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://girtby.net/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='girtby.net' href='http://girtby.net' />
<link rel='start' title='Thunderbirds Are Go-ne' href='http://girtby.net/archives/2004/09/20/thunderbirds-are-go-ne/' />
<link rel='prev' title='Trackback Attack' href='http://girtby.net/archives/2006/12/04/trackback-attack/' />
<link rel='next' title='Easing into Ubuntu' href='http://girtby.net/archives/2006/12/17/easing-into-ubuntu/' />
<meta name="generator" content="WordPress 2.9-rare" />
<link rel='canonical' href='http://girtby.net/archives/2006/12/07/the-switch/' />
			<script type="text/javascript" src="http://girtby.net/wp-content/plugins/flickr-tag/js/flickrTagTooltips.js"></script>

			<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTagTooltips.css" type="text/css" rel="stylesheet"/>
	
		<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTag.css" type="text/css" rel="stylesheet"/>
	</head>
<body>
<div class="container">
	<div class="header">
        <div class="search">
            <form method="get" id="sform" action="http://girtby.net/">
                <input type="text" id="q" value="" name="s" size="15" />
			</form>
        </div><!-- end search -->
        			        <h1><a href="http://girtby.net/">this blog is girtby.net</a> 
            </h1>
	</div><!-- end header -->


<div class="blogads">

<!-- Your Stuff Here -->

</div>


    						
      <div class="post">
          <div class="metainfo">
              <p>Posted<br />
                <abbr class="published" title="Thu, 07 Dec 2006 18:16:39 -0500">7 December 2006 @ 6pm</abbr></p>
                <p>Tagged<br />
                <a href="http://girtby.net/archives/category/nerd-factor-x/" title="View all posts in Nerd Factor X" rel="category tag">Nerd Factor X</a></p>
                		    </div>
		    <div class="content">
		        <h3>The Switch 
		        </h3>
		        <p>PC1: Hello, I&#8217;m a PC</p>

<p>PC2: And I&#8217;m also a PC.</p>

<p><span id="more-223"></span></p>

<p>PC1: Ooooh, my aching disk controller.</p>

<p>PC2: What&#8217;s the matter, PC1?</p>

<p>PC1: Well, I&#8217;ve got these two 250GB drives and they work fine in isolation, but whenever they are in a mirrored configuration, they develop subtle filesystem corruption problems. That leads to kernel panics and spontaneous reboots. It&#8217;s not nice. I&#8217;ve tried both the hardware <em>and</em> software RAID1 solutions, and it&#8217;s the same deal both times.</p>

<p>PC2: Ouch.</p>

<p>PC1: Yes. So far I&#8217;ve been limping along in software RAID mode with write caching turned off. This <em>mostly</em> prevents the filesystem corruption but not entirely. Also it makes writes glacially slow.</p>

<p>PC2: How slow?</p>

<p>PC1: Like, about 6 MB/sec. About 6 times slower than they should be. Let&#8217;s see, at that rate, it would take about 11 hours to fill the disk. I <em>could</em> get a new SATA controller card, but what&#8217;s the chances the same thing might not happen again?</p>

<p>PC2: Well listen PC1, why don&#8217;t I take over the file server duties with those disks? I&#8217;ve got two SATA ports on-board, everything should Just Work. Pretty sure I can handle the extra load, I have an Athlon XP 3200+ CPU, you know.</p>

<p>PC1: Hey you don&#8217;t need a fast CPU to be a big dumb file server, bub. My Celeron 1.13GHz suits me <em>just fine</em>. But anyway, sure, knock yourself out. Just get yourself set up with the latest FreeBSD 6.1-RELEASE and then we&#8217;ll get those drives installed.</p>

<p><em>(time passes)</em></p>

<p>PC2: Well that didn&#8217;t go so well.</p>

<p>PC1: Why, what happened?</p>

<p>PC2: Well I got FreeBSD installed OK, but then I found out the bad news. There is no nVidia driver for FreeBSD/amd64. And the standard X.org driver refuses to work with my new Dell LCD monitor.</p>

<p>PC1: Oh, poor diddums. I don&#8217;t even <em>have</em> a monitor and you don&#8217;t see me complaining.</p>

<p>PC2: Well your lack of monitor might have something to do your integrated graphics chipset, but the less said about that, the better. So anyway, back to me. I was a bit stuck without the graphics driver, and it was the perfect excuse to do something I&#8217;ve always wanted to do.</p>

<p>PC1: What, get that Hello Kitty desktop theme installed?</p>

<p>PC2: No, something more drastic than that. I&#8217;ve switched to &#8230; <strong>Ubuntu Linux!</strong></p>

<p>PC1: OMG, you must have been desperate.</p>

<p>PC2: Don&#8217;t be nasty. Anyway, it worked. Ubuntu seems to recognise all of my hardware. Well, almost all. Unfortunately, I had the same video sync problem that I had encountered with FreeBSD. Fortunately, there was a &#8220;safe VGA mode&#8221; on the installer live CD. Unfortunately, it didn&#8217;t work. Fortunately, there was a workaround. This was enough to get Ubuntu installed, and then the official nVidia amd64 video driver.</p>

<p>PC1: So after all that, are you ready to install the drives? They&#8217;ll need to be re-fomatted because Linux doesn&#8217;t understand UFS very well. Tell you what, I&#8217;ll give you one drive, you create a RAID-1 array with one disk and one one missing disk. Then copy all the stuff across, I&#8217;ll give you the other disk, and you can rebuild the array.</p>

<p>PC2: Sounds like a plan.</p>

<p><em>(more time passes)</em></p>

<p>PC2: Ubuntu doesn&#8217;t like me.</p>

<p>PC1: &#8220;<a href="http://www.imdb.com/title/tt0076759/quotes">I don&#8217;t like you either. You just watch yourself. We&#8217;re wanted men. I have the death sentence on twelve systems.</a>&#8220;</p>

<p>PC2: Shut up, nerd. Apparently <code>mdadm</code> is the RAID tool of choice for Linux, so I installed it. But it requires RAID &#8220;personalities&#8221; to be loaded into the kernel, and I have no idea how to do that. Also it requires <code>/dev/md0</code> to be present and, well, it isn&#8217;t. All of the RAID doco starts with those two basic requirements and I have no idea why my system is not meeting them. I can create <code>/dev/md0</code> using the <code>sudo mknod /dev/md0 b 9 1</code> magical incantation, but it goes away next reboot. No idea what&#8217;s going on.</p>

<p>PC1: So I guess I&#8217;m still useful for something after all! I may corrupt my filesystem once in a while but at least I have one!</p>

<p>PC2: Ubuntu doesn&#8217;t like me, I told ya.</p>

<p>PC1: Don&#8217;t anthropomorphise operating systems. They hate that.</p>
		        <br clear="left" />
		    </div>
        </div><!-- end post -->

			
<!-- You can start editing here. -->


<div id="comments" class="post">

	<h3 class="comments_headers">4 Comments</h3>

</div>
	
	
			
        <div class="post" id="comment-1508">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://plasmasturm.org/' rel='external nofollow' class='url'>Aristotle Pagaltzis</a><br />
                <input type="hidden" name="post_date" value="Thu, 07 Dec 2006 18:16:39 -0500" />
                <abbr class="commented" title="Thu, 07 Dec 2006 18:16:39 -0500">7 December 2006 @ 6pm</abbr><br />
                <a href="#comment-1508">#</a></p>
			</div>
			<div class="content">
				<blockquote>
  <p>it goes away next reboot. No idea what’s going on.</p>
</blockquote>

<p>It’s called Udev.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1509">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Thu, 07 Dec 2006 18:16:39 -0500" />
                <abbr class="commented" title="Thu, 07 Dec 2006 18:16:39 -0500">7 December 2006 @ 6pm</abbr><br />
                <a href="#comment-1509">#</a></p>
			</div>
			<div class="content">
				<p>OK, got it working.</p>

<p>The magic incantation: <code>sudo dpkg-reconfigure mdadm</code></p>

<p>The really frustrating part is that there are a lot of people on the various forums who are offering solutions but none of them really address the underlying problem. Several suggest hacks to create the <code>/dev/md0</code> device entries either manually with <code>MAKEDEV</code> or to get udev to do it using some undocumented (!) <code>links.conf</code> file. Others suggest hacks to the <code>mdadm.conf</code> file to tell it what raid arrays are configured (which should not be necessary because this information is stored in the filesystem superblocks anyway). So many answers, but all of them band-aids over the real underlying cause.</p>

<p>The way I understand it, it should work is as follows:</p>

<ol>
<li>System starts up, early in the startup sequence it initialises udev and the filesystem</li>
<li>Certain filesystems are marked as raid-autodetect, which triggers the kernel to load the relevant module (<code>md_mod</code> I believe).</li>
<li>Later in the system boot sequence, mdadm-raid is invoked. This scans the partitions for raid-arrays previously created and &#8220;assembles&#8221; them. It also creates the <code>/dev/md0</code> entries by communicating with udev.</li>
<li>The newly-created raid device is mounted in accordance with <code>/etc/fstab</code>.</li>
<li>The raid monitoring daemon is started.</li>
</ol>

<p>I think what was happening in my case was that the kernel wasn&#8217;t set up somehow to trigger the md module to be loaded. This needs to be done in a special way because you normally need md to be compiled into the kernel. <code>dpkg-reconfigure mdadm</code> obviously takes care of it, and I&#8217;d like to know exactly how it does this. But maybe that&#8217;s something for another time.</p>

<p>Despite spending far too much time on this, I&#8217;m glad I&#8217;ve got a better understanding about it all, and that it seems to be working properly without hacking. Disappointed that the correct solution was so difficult to come across.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1510">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Thu, 07 Dec 2006 18:16:39 -0500" />
                <abbr class="commented" title="Thu, 07 Dec 2006 18:16:39 -0500">7 December 2006 @ 6pm</abbr><br />
                <a href="#comment-1510">#</a></p>
			</div>
			<div class="content">
				<p>The second drive is installed, added to the array, and it&#8217;s rebuilding now:</p>

<pre><code>alastair@pierre:~$ cat /proc/mdstat
Personalities : [raid1]
md0 : active raid1 sdb[0] sda1[1]
      244195904 blocks [2/1] [_U]
      [&gt;....................]  recovery =  0.9% (2265920/244195904) finish=68.9min speed=58440K/sec

unused devices: &lt;none&gt;
</code></pre>

<p>Lovely. 68 mins a lot quicker than 11 hours.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1511">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Thu, 07 Dec 2006 18:16:39 -0500" />
                <abbr class="commented" title="Thu, 07 Dec 2006 18:16:39 -0500">7 December 2006 @ 6pm</abbr><br />
                <a href="#comment-1511">#</a></p>
			</div>
			<div class="content">
				<p>To cap it all off, it looks like <a href="http://people.fruitsalad.org/adridg/bobulate/index.php?url=archives/320-Thank-you,-openSUSE-from-a-FreeBSD-guy.html">there <em>is</em> a way of getting the nVidia driver working on FreeBSD/amd64</a>. If only I&#8217;d discovered this about a week ago.</p> 
							</div>
		<br clear="left" />
		</div>
		
	

	<!-- Comment Form -->

	    

			
				
<div class="posttopline">
	<span class="previous">&larr; <a href="http://girtby.net/archives/2006/12/04/trackback-attack/" rel="prev">Trackback Attack</a></span>
	<span class="next"><a href="http://girtby.net/archives/2006/12/17/easing-into-ubuntu/" rel="next">Easing into Ubuntu</a> &rarr;</span>
</div>

<br clear="all" />

    <div class="footer">
		
        <div class="first">
        <div id="text-318154731" class="widget widget_text"><h5 class="widgettitle">Archives</h5>			<div class="textwidget"><ul>
<li><a href="/archives/2009">2009</a></li>
<li><a href="/archives/2008">2008</a></li>
<li><a href="/archives/2007">2007</a></li>
<li><a href="/archives/2006">2006</a></li>
<li><a href="/archives/2005">2005</a></li>
<li><a href="/archives/2004">2004</a></li>
</ul></div>
		</div>		</div>

        <div class="sidebar">
        <div id="text-326846052" class="widget widget_text"><h5 class="widgettitle">Leveraged Synergy</h5>			<div class="textwidget"><p>Hello, I&#8217;m Alastair Rankine. I once had a blog, and you've found it. <a href="/about/">Would you like to know more?</a></p>
<p>From time to time I made offerings to the internet. <a href="/offerings/">Would you like some?</a></p>
</div>
		</div>        </div>

        <div class="last">
        <div id="linkcat-2" class="widget widget_links"><h5 class="widgettitle">Blogroll</h5>
	<ul class='xoxo blogroll'>
<li><a href="http://bjkeefe.blogspot.com">bjkeefe</a></li>
<li><a href="http://brainsnorkel.com">brainsnorkel</a></li>
<li><a href="http://deadlybloodyserious.com">Deadly Bloody Serious</a></li>
<li><a href="http://blog.alphajuliet.com/">follicle</a></li>
<li><a href="http://madbean.com/">madbean</a></li>
<li><a href="http://marxyblog.blogspot.com">marxy&#8217;s musing on technology</a></li>
<li><a href="http://mattrubinstein.com.au">mattrubinstein.com.au</a></li>
<li><a href="http://somethinkodd.com/oddthinking">OddThinking</a></li>

	</ul>
</div>
        </div>

	    </div><!-- end footer -->

        <br clear="all" />
        
		<div class="copyright">
        	        	<span class="previous">&larr; <a href="http://girtby.net">Back to Home</a></span>
                        <p>Powered by <a href="http://wordpress.org">WordPress</a> using the <a href="http://powazek.com/posts/516">DePo Clean Theme</a> <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/au/"><img alt="Creative Commons License" class="badge" width=80 height=15 src="http://i.creativecommons.org/l/by-sa/2.5/au/80x15.png" /></a></p>
            		</div>

	</div> <!-- end container -->
</body>
</html>
