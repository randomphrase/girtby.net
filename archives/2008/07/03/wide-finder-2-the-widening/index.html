<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>girtby.net &#8211;   Wide Finder 2: The Widening</title>

<meta name="verify-v1" content="unGvQ7Jwj5liZb2PzH2ckduvpe8Ua3Ls0MONzCHQQn4=" />

<link rel="stylesheet" href="http://girtby.net/wp-content/themes/depo-clean/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Articles Feed" href="http://girtby.net/feed/atom/" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Comments Feed" href="http://girtby.net/comments/feed/atom/" />

<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://arankine.myopenid.com/" />

<link rel="meta" href="http://girtby.net/labels.rdf" type="application/rdf+xml" title="ICRA labels" />
<meta http-equiv="pics-Label" content='(pics-1.1 "http://www.icra.org/pics/vocabularyv03/" l gen true for "http://girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1) gen true for "http://www.girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1))' />

<link rel="prev" href="http://girtby.net/archives/2008/06/04/twitter-over-ip/" />
<link rel="next" href="http://girtby.net/archives/2008/07/28/a-serious-compact/" />

<link rel="pingback" href="http://girtby.net/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Feed" href="http://girtby.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Comments Feed" href="http://girtby.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Wide Finder 2: The Widening Comments Feed" href="http://girtby.net/archives/2008/07/03/wide-finder-2-the-widening/feed/" />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>
<script type='text/javascript' src='http://girtby.net/wp-content/themes/depo-clean/javascript/friendly_dates.js?ver=2.9-rare'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://girtby.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://girtby.net/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='girtby.net' href='http://girtby.net' />
<link rel='start' title='Thunderbirds Are Go-ne' href='http://girtby.net/archives/2004/09/20/thunderbirds-are-go-ne/' />
<link rel='prev' title='Twitter over IP' href='http://girtby.net/archives/2008/06/04/twitter-over-ip/' />
<link rel='next' title='A Serious Compact' href='http://girtby.net/archives/2008/07/28/a-serious-compact/' />
<meta name="generator" content="WordPress 2.9-rare" />
<link rel='canonical' href='http://girtby.net/archives/2008/07/03/wide-finder-2-the-widening/' />
			<script type="text/javascript" src="http://girtby.net/wp-content/plugins/flickr-tag/js/flickrTagTooltips.js"></script>

			<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTagTooltips.css" type="text/css" rel="stylesheet"/>
	
		<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTag.css" type="text/css" rel="stylesheet"/>
	</head>
<body>
<div class="container">
	<div class="header">
        <div class="search">
            <form method="get" id="sform" action="http://girtby.net/">
                <input type="text" id="q" value="" name="s" size="15" />
			</form>
        </div><!-- end search -->
        			        <h1><a href="http://girtby.net/">this blog is girtby.net</a> 
            </h1>
	</div><!-- end header -->


<div class="blogads">

<!-- Your Stuff Here -->

</div>


    						
      <div class="post">
          <div class="metainfo">
              <p>Posted<br />
                <abbr class="published" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr></p>
                <p>Tagged<br />
                <a href="http://girtby.net/archives/category/nerd-factor-x/" title="View all posts in Nerd Factor X" rel="category tag">Nerd Factor X</a></p>
                <p>Tags<br/><a href="http://girtby.net/archives/tag/c/" rel="tag">c++</a>, <a href="http://girtby.net/archives/tag/performance/" rel="tag">performance</a>, <a href="http://girtby.net/archives/tag/wide-finder/" rel="tag">wide finder</a></p>		    </div>
		    <div class="content">
		        <h3>Wide Finder 2: The Widening 
		        </h3>
		        <p><code>&lt;movie-trailer-guy&gt;</code> Many months ago he attempted Tim Bray&#8217;s first <a href="/archives/2007/10/9/wide-finder-in-c">Wide Finder in C++</a>, mainly as a coding exercise. Back then the goal was readability and conciseness. This time &#8230; it&#8217;s performanceal. <code>&lt;/movie-trailer-guy&gt;</code></p>

<p><span id="more-3049"></span></p>

<h4>Targeting the Hardware of the Future</h4>

<p>Computer architecture evolution is currently in the process of changing direction. Instead of CPUs becoming progressively ever faster, they are going &#8220;wider&#8221;. This means more processing cores, each of which is relatively low-powered. The combined processing power of multiple cores is greater than is achievable with traditional single core architectures, but requires new programming techniques. These techniques are perhaps well-understood at a theory level, but the Wide Finder project is an attempt to put theory into practice with real-world tasks by everyday coders, such as myself.</p>

<p>The goal of a <a href="http://wikis.sun.com/display/WideFinder/Wide+Finder+Home">Wide Finder 2</a> implementation is to produce some simple statistics from a very large (42GB) data file. The target machine is a Sun Fire T2000 with 8 cores (32 threads) and 32 GB of RAM. The task is relatively simple: we have to read the file, which contains web server log entries, and produce some elementary statistics such as the top 10 pages by hit, the top 10 clients, and so forth. Obviously it&#8217;s I/O bound &#8230; or is it?</p>

<p>I attempted this in (hopefully) idiomatic C++, using the <a href="http://www.boost.org/">Boost</a> libraries. For those unfamiliar with Boost, you can think of it as the non-standard library, or maybe the unofficial standard libary. Basically if you&#8217;re not using Boost libraries today, you soon will be, because many of the them have gone on to form the basis for the TR1 standard library extensions, and hence targeted for inclusion in the next official C++ standard, known as C++0x. Thanks to Boost, my code is completely portable, compiling on both gcc (on my Mac) and Sun Studio compiler (on the T2000) without even a single <code>#ifdef</code>.</p>

<h4>The Results, So Far</h4>

<p>So, C++ should be able to whip all those other languages like Java into submission you might think, right? Well, I think the <a href="http://wikis.sun.com/display/WideFinder/Results">results</a> speak for themselves. My time of 16 minutes is prettymuch in the middle of the pack. Not bad, but not outstanding either, and still behind some of the Java (or JVM-based) implementations. I have a few more optimisations up my sleeve though, so we&#8217;ll see how they pan out.</p>

<p>However the clear winner in my view, and hence worthy of much more recognition than it currently enjoys, is <a href="http://caml.inria.fr/ocaml/">OCaml</a>. With a run time of 5 minutes this is perilously <a href="http://groups.google.com/group/wide-finder/browse_thread/thread/06cf51fbbd4774e0">close to the raw I/O speed</a> sustainable on this box. Not only that but it was all done with ~150 lines of code which is frankly amazing (especially compared to my ~500 line C++ implementation). So OCaml is definitely a language to look at, in my humble opinion.</p>

<p>Hit the links from that results page for some often fascinating insights from the other Wide Finder implementers.</p>

<h4>How To Go Wide</h4>

<p>Fundamentally I think my approach is fairly similar to many of the other Wide Finders. This was to divide the input file into chunks, then walk through each using multiple threads. Each thread accumulates statistics in the form of hash tables. The individual hash tables are then merged before finally being sorted to produce the top-10 reports.</p>

<p>I want to share in detail some of the techniques that I used but like I said I&#8217;m still refining them. For now let me just point to a couple of key techniques that got me into contention for this project:</p>

<ul>
<li><p>When it comes to this much data, you can&#8217;t afford to copy anything. This means I/O using <code>mmap</code>, and doing as much processing &#8220;in-place&#8221; as possible. For C++ this also means throwing out the <code>iostreams</code> library (even though it is otherwise quite well suited to this type of task, as demonstrated previously). And even with a 64-bit binary, you really don&#8217;t want to mmap an entire 42GB data file into memory, trust me [<strong>Update:</strong> Or maybe not. See <a href="#comment-3058">comment</a> below]. So I ended up with some quite ugly code to deal with mmap-ing segments of the input file while respecting chunk (ie line) boundaries and page alignment boundaries.</p></li>
<li><p>Multi-threaded C++ applications are always at risk of experiencing contention, but this is especially so when it comes to memory allocation. Doing too much allocation can kill any parallel processing you do with C++, because <code>malloc</code> and <code>free</code> both grab global mutexes (or worse, spinlocks) prior to doing their stuff. To solve this problem I ended up using a custom thread-specific memory allocator based on the Boost.Pool library. This minimises the number of times that the thread grabs memory during the normal course of operation. Code forthcoming.</p></li>
</ul>

<p>Mad props to Shark, which is part of the Mac OS X developer suite. It pinpointed my bottlenecks  very quickly and simply. An indispensable tool, don&#8217;t jump over <em>this</em> Shark.</p>

<h4>Future Work</h4>

<p>So I&#8217;ve got some more ideas on how to go even wider, and I&#8217;ll update here with the results. Basically it&#8217;s applying the above two techniques more thoroughly; minimise copying of data, and minimise memory allocation. (In particular the Boost.Regex library is next on my list to convert to using a thread-specific memory pool). Will let you know how it goes.</p>
		        <br clear="left" />
		    </div>
        </div><!-- end post -->

			
<!-- You can start editing here. -->


<div id="comments" class="post">

	<h3 class="comments_headers">7 Comments</h3>

</div>
	
	
			
        <div class="post" id="comment-1801">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://brainsnorkel.com' rel='external nofollow' class='url'>Chris</a><br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1801">#</a></p>
			</div>
			<div class="content">
				<p>Grats.  That&#8217;s looking pretty good.  Have you looked at something like <a href="http://prisms.cs.umass.edu/emery/index.php?page=download-hoard">Hoard</a> to help with mallocs?  You&#8217;re in the best position to profile the parts that are easiest to improve, but Hoard might be a pretty easy drop-in if memory allocation is still hurting.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1802">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1802">#</a></p>
			</div>
			<div class="content">
				<p>Thanks Chris. Yes I have looked at hoard, and in fact we use it at $WORK. However I&#8217;m finding I get much better performance improvement by switching to a Boost.Pool accessed through a thread-specific pointer. This drastically reduces the need to do malloc in the first place.</p>

<p>On the flip side, I can reduce the need to deallocate memory simply by introducing memory leaks &#8230; yes, you read that right! Basically when you have many millions of objects allocated it can take quite a while to deallocate them all. There&#8217;s something like a 10-second pause after processing the 42G data file while my application de-allocates all of the objects, so an easy performance win is simply Not Do That. Every second counts, particularly when you have Java implementations to beat &#8230;</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1803">
		    <div class="metainfo">
                <p>Posted by<br />Thatcher<br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1803">#</a></p>
			</div>
			<div class="content">
				<p>Re: thread contention in malloc, are you aware of tcmalloc?  <a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html">http://goog-perftools.sourceforge.net/doc/tcmalloc.html</a></p>

<p>-T</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1804">
		    <div class="metainfo">
                <p>Posted by<br />Brian<br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1804">#</a></p>
			</div>
			<div class="content">
				<blockquote>
  <p>And even with a 64-bit binary, you
  really don’t want to mmap an entire
  42GB data file into memory, trust me.</p>
</blockquote>

<p>Well I don&#8217;t trust you.  I currently and routinely mmap in 10+TB in one shot on a 64bit machine.
So what&#8217;s the problem ?  Elaborate plesae?</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1805">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1805">#</a></p>
			</div>
			<div class="content">
				<blockquote>
  <p>Well I don’t trust you.</p>
</blockquote>

<p>Well, as it turns out, Brian was right not to trust me. I was too hasty in condemning the all-at-once mmap.</p>

<p>Here&#8217;s a test app:</p>

<pre class="htmlize">
<span class="constant">boost</span>::<span class="constant">iostreams</span>::<span class="type">mapped_file_source</span> <span class="variable-name">source</span>(<span class="type">argv</span>[1]);
<span class="type">unsigned</span> <span class="variable-name">lines</span> = <span class="constant">std</span>::count(source.begin(), source.end(), <span class="string">'\n'</span>);
<span class="constant">std</span>::cout &lt;&lt; argv[1] &lt;&lt; <span class="string">": "</span> &lt;&lt; lines &lt;&lt; <span class="string">" lines"</span> &lt;&lt; <span class="constant">std</span>::endl;
</pre>

<p>As you can see it just counts the number of \n characters in the requested file. I ran this on the Wide Finder 2 full data set, and here&#8217;s what happened:</p>

<pre><code>~/wf2/ 512&gt; time ./readmmap /wf1/data/logs/O.all
/wf1/data/logs/O.all: 218201129 lines

real    16m0.565s
user    7m42.454s
sys     7m53.235s
</code></pre>

<p>Two important things to note here. First, obviously mmap-ing the whole file works as advertised. But more importantly, it seems that my Wide Finder 2 implementation is <em>already</em> running at I/O speed.</p>

<p>But other Wide Finder 2 implementations are going faster, which raises the obvious question as to how. mmap is traditionally the fasted form of I/O, given that it doesn&#8217;t have to copy the data from kernel space into user space. But obviously that rule doesn&#8217;t hold any longer, at least for Solaris.</p>

<p>More investigation needed, I feel.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1806">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://blog.quaddmg.com' rel='external nofollow' class='url'>Sunny Kalsi</a><br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1806">#</a></p>
			</div>
			<div class="content">
				<p>Could it be that these implementations are reading from the file sequentially? If you read from the file sequentially in tiny chunks, dynamically starting threads and letting them die, you might get better results than using something which will possibly cache your data or maybe cause your disk to do random reads instead of sequential. If it were me I&#8217;d try something like this:</p>

<ol>
<li>Have 1 thread keeping stats.</li>
<li>Have dynamically starting threads on block boundaries &#8211; i.e. read 4k at a time (or whatever the HDD&#8217;s block size is) and start the thread with that instead of explicitly searching for a newline. These will send messages to two threads. One for the statistics, and another for a &#8220;residual&#8221; (a message not ending a line).</li>
<li>Have another thread which waits for residuals and matches them up. Once it gets a bunch of em, it can dynamically start one of the threads in (2).</li>
</ol>

<p>The only downside is the mallocs. IMO you need to copy data or else you&#8217;re hosed from a multi-threaded perspective. Just thinking out loud here&#8230;</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1807">
		    <div class="metainfo">
                <p>Posted by<br />Marc<br />
                <input type="hidden" name="post_date" value="Thu, 03 Jul 2008 03:27:00 -0400" />
                <abbr class="commented" title="Thu, 03 Jul 2008 03:27:00 -0400">3 July 2008 @ 3am</abbr><br />
                <a href="#comment-1807">#</a></p>
			</div>
			<div class="content">
				<p>Hello,</p>

<p>what compiler options are you using? In particular, are you making use of prefetch? Specifying a page size? On something as simple as the exemple that counts the newlines it could make a difference.</p> 
							</div>
		<br clear="left" />
		</div>
		
	

	<!-- Comment Form -->

	    

			
				
<div class="posttopline">
	<span class="previous">&larr; <a href="http://girtby.net/archives/2008/06/04/twitter-over-ip/" rel="prev">Twitter over IP</a></span>
	<span class="next"><a href="http://girtby.net/archives/2008/07/28/a-serious-compact/" rel="next">A Serious Compact</a> &rarr;</span>
</div>

<br clear="all" />

    <div class="footer">
		
        <div class="first">
        <div id="text-318154731" class="widget widget_text"><h5 class="widgettitle">Archives</h5>			<div class="textwidget"><ul>
<li><a href="/archives/2009">2009</a></li>
<li><a href="/archives/2008">2008</a></li>
<li><a href="/archives/2007">2007</a></li>
<li><a href="/archives/2006">2006</a></li>
<li><a href="/archives/2005">2005</a></li>
<li><a href="/archives/2004">2004</a></li>
</ul></div>
		</div>		</div>

        <div class="sidebar">
        <div id="text-326846052" class="widget widget_text"><h5 class="widgettitle">Leveraged Synergy</h5>			<div class="textwidget"><p>Hello, I&#8217;m Alastair Rankine. I once had a blog, and you've found it. <a href="/about/">Would you like to know more?</a></p>
<p>From time to time I made offerings to the internet. <a href="/offerings/">Would you like some?</a></p>
</div>
		</div>        </div>

        <div class="last">
        <div id="linkcat-2" class="widget widget_links"><h5 class="widgettitle">Blogroll</h5>
	<ul class='xoxo blogroll'>
<li><a href="http://bjkeefe.blogspot.com">bjkeefe</a></li>
<li><a href="http://brainsnorkel.com">brainsnorkel</a></li>
<li><a href="http://deadlybloodyserious.com">Deadly Bloody Serious</a></li>
<li><a href="http://blog.alphajuliet.com/">follicle</a></li>
<li><a href="http://madbean.com/">madbean</a></li>
<li><a href="http://marxyblog.blogspot.com">marxy&#8217;s musing on technology</a></li>
<li><a href="http://mattrubinstein.com.au">mattrubinstein.com.au</a></li>
<li><a href="http://somethinkodd.com/oddthinking">OddThinking</a></li>

	</ul>
</div>
        </div>

	    </div><!-- end footer -->

        <br clear="all" />
        
		<div class="copyright">
        	        	<span class="previous">&larr; <a href="http://girtby.net">Back to Home</a></span>
                        <p>Powered by <a href="http://wordpress.org">WordPress</a> using the <a href="http://powazek.com/posts/516">DePo Clean Theme</a> <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/au/"><img alt="Creative Commons License" class="badge" width=80 height=15 src="http://i.creativecommons.org/l/by-sa/2.5/au/80x15.png" /></a></p>
            		</div>

	</div> <!-- end container -->
</body>
</html>
