<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>girtby.net &#8211;   Kata Four in C++</title>

<meta name="verify-v1" content="unGvQ7Jwj5liZb2PzH2ckduvpe8Ua3Ls0MONzCHQQn4=" />

<link rel="stylesheet" href="http://girtby.net/wp-content/themes/depo-clean/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Articles Feed" href="http://girtby.net/feed/atom/" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Comments Feed" href="http://girtby.net/comments/feed/atom/" />

<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://arankine.myopenid.com/" />

<link rel="meta" href="http://girtby.net/labels.rdf" type="application/rdf+xml" title="ICRA labels" />
<meta http-equiv="pics-Label" content='(pics-1.1 "http://www.icra.org/pics/vocabularyv03/" l gen true for "http://girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1) gen true for "http://www.girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1))' />

<link rel="prev" href="http://girtby.net/archives/2007/02/18/my-password-safety-technique-is-unbreakable/" />
<link rel="next" href="http://girtby.net/archives/2007/03/09/c-1-unicode-0/" />

<link rel="pingback" href="http://girtby.net/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Feed" href="http://girtby.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Comments Feed" href="http://girtby.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Kata Four in C++ Comments Feed" href="http://girtby.net/archives/2007/02/26/kata-four-in-c/feed/" />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>
<script type='text/javascript' src='http://girtby.net/wp-content/themes/depo-clean/javascript/friendly_dates.js?ver=2.9-rare'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://girtby.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://girtby.net/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='girtby.net' href='http://girtby.net' />
<link rel='start' title='Thunderbirds Are Go-ne' href='http://girtby.net/archives/2004/09/20/thunderbirds-are-go-ne/' />
<link rel='prev' title='My Password Safety Technique Is Unbreakable' href='http://girtby.net/archives/2007/02/18/my-password-safety-technique-is-unbreakable/' />
<link rel='next' title='C++ 1, Unicode 0' href='http://girtby.net/archives/2007/03/09/c-1-unicode-0/' />
<meta name="generator" content="WordPress 2.9-rare" />
<link rel='canonical' href='http://girtby.net/archives/2007/02/26/kata-four-in-c/' />
			<script type="text/javascript" src="http://girtby.net/wp-content/plugins/flickr-tag/js/flickrTagTooltips.js"></script>

			<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTagTooltips.css" type="text/css" rel="stylesheet"/>
	
		<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTag.css" type="text/css" rel="stylesheet"/>
	</head>
<body>
<div class="container">
	<div class="header">
        <div class="search">
            <form method="get" id="sform" action="http://girtby.net/">
                <input type="text" id="q" value="" name="s" size="15" />
			</form>
        </div><!-- end search -->
        			        <h1><a href="http://girtby.net/">this blog is girtby.net</a> 
            </h1>
	</div><!-- end header -->


<div class="blogads">

<!-- Your Stuff Here -->

</div>


    						
      <div class="post">
          <div class="metainfo">
              <p>Posted<br />
                <abbr class="published" title="Mon, 26 Feb 2007 12:37:00 -0500">26 February 2007 @ 12pm</abbr></p>
                <p>Tagged<br />
                <a href="http://girtby.net/archives/category/nerd-factor-x/" title="View all posts in Nerd Factor X" rel="category tag">Nerd Factor X</a></p>
                <p>Tags<br/><a href="http://girtby.net/archives/tag/c/" rel="tag">c++</a>, <a href="http://girtby.net/archives/tag/coding/" rel="tag">coding</a></p>		    </div>
		    <div class="content">
		        <h3>Kata Four in C++ 
		        </h3>
		        <p>On a whim, I attempted Dave Thomas&#8217; <a href="http://codekata.pragprog.com/2007/01/kata_four_data_.html">Kata Four</a> in C++. Yes that&#8217;s right, C++.</p>

<p>Here&#8217;s what I ended up with, feel free to throw peanuts.</p>

<p><span id="more-1473"></span></p>

<p>I did the parts in order, without looking ahead. When it came to part three of the exercise, it became apparent that I needed to separate the analysis of the file from the mechanics of reading it. I used the common <a href="http://en.wikipedia.org/wiki/Function_object">Functor</a> idiom, calling it with each line of input:</p>

<pre class="htmlize">
<span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="type">T</span>&gt;
<span class="type">void</span> <span class="function-name">analyze_file</span>(<span class="keyword">const</span> <span class="type">char</span> * <span class="variable-name">dat</span>, <span class="type">T</span> &amp; <span class="variable-name">an</span>)
{
  <span class="type">fstream</span> <span class="variable-name">fs</span>(dat);
  <span class="type">unsigned</span> <span class="variable-name">processed</span> = 0;

  <span class="keyword">while</span>(<span class="constant">true</span>) {
    <span class="type">string</span> <span class="variable-name">line</span>;
    getline(fs, line);
    <span class="keyword">if</span> (<span class="negation-char">!</span>fs.good())
      <span class="keyword">break</span>;
    <span class="keyword">if</span> (an(line))
      processed++;
  }
  cout &lt;&lt; processed &lt;&lt; <span class="string">" lines processed"</span> &lt;&lt; endl;
  <span class="keyword">if</span> (processed) {
    cout &lt;&lt; an &lt;&lt; endl;
  }
}
</pre>

<p>Then it&#8217;s a simple matter of defining a functor for each type of analysis. For the weather data, it looks like this:</p>

<pre class="htmlize">
<span class="keyword">class</span> <span class="type">WeatherAnalyzer</span> {
<span class="keyword">public</span>:
  <span class="function-name">WeatherAnalyzer</span>() : minday(0), minspread(<span class="constant">numeric_limits</span>&lt;<span class="type">unsigned</span>&gt;::max()) {}
  <span class="type">bool</span> <span class="keyword">operator</span><span class="function-name">()</span> (<span class="keyword">const</span> <span class="type">string</span> &amp; <span class="variable-name">line</span>);
  <span class="type">unsigned</span> <span class="variable-name">minday</span>, <span class="variable-name">minspread</span>;
};

<span class="type">ostream</span> &amp; <span class="keyword">operator</span> <span class="function-name">&lt;&lt;</span> (<span class="type">ostream</span> &amp; <span class="variable-name">os</span>, <span class="type">WeatherAnalyzer</span> &amp; <span class="variable-name">w</span>)
{
  <span class="keyword">return</span> os &lt;&lt; <span class="string">"Min spread = "</span> &lt;&lt; w.minspread &lt;&lt; <span class="string">" (day "</span> &lt;&lt; w.minday &lt;&lt; <span class="string">")"</span>;
}

<span class="type">bool</span> <span class="constant">WeatherAnalyzer</span>::<span class="keyword">operator</span><span class="function-name">()</span> (<span class="keyword">const</span> <span class="type">string</span> &amp; <span class="variable-name">line</span>)
{
  <span class="type">istringstream</span> <span class="variable-name">ls</span>(line);
  <span class="type">unsigned</span> <span class="variable-name">d</span>, <span class="variable-name">maxt</span>, <span class="variable-name">mint</span>;
  ls &gt;&gt; d &gt;&gt; maxt &gt;&gt; mint;
  <span class="keyword">if</span> (<span class="negation-char">!</span>ls.good() || (maxt &lt; mint))
    <span class="comment-delimiter">// </span><span class="comment">ignore unparseable lines:
</span>    <span class="keyword">return</span> <span class="constant">false</span>;

  <span class="type">unsigned</span> <span class="variable-name">spread</span> = maxt - mint;
  <span class="keyword">if</span> (spread &lt; minspread) {
    minday = d;
    minspread = spread;
  }
  <span class="keyword">return</span> <span class="constant">true</span>;
}</pre>

<p>Add some <code>#include</code>s, a <code>main()</code>, and we&#8217;re all set. It all came together pretty quickly thanks mainly to the power of the C++ iostreams library.</p>

<p>All in all I think it came out pretty well, although it is by no means perfect. If it was going into production here&#8217;s what I&#8217;d be looking at:</p>

<ul>
<li>Defining a proper stream insertion operator that can handle wide chars.</li>
<li>Better error reporting, particularly when the input file cannot be opened.</li>
<li>Logging of &#8220;unexpected&#8221; unparseable lines.</li>
<li>Getter methods, rather than public member variables, for accessing the accumulated values of the functor.</li>
</ul>

<p>In answer to the Kata questions:</p>

<ul>
<li>I made some early design decisions which were not validated when writing subsequent programs. Specifically I decided that each line should be parsed strictly once the start of data was detected. In other words, I had a <code>skip_to_data</code> function in my original part 1 solution. This was overturned when I went to part two because I observed that it was better to simply skip lines that could not be parsed, particularly when there was spurious data in the middle of the dataset. However making this change was fairly simple.</li>
<li>The second program was a copy and paste of the first, with the relevant changes in fairly obvious parts. (This is usually very poor practice, but is justified in this case because I wasn&#8217;t actually shipping anything)</li>
<li>I don&#8217;t believe that factoring out common code is always a good thing. For example, it would have been a fairly easy change to use an abstract <code>Analyzer</code> base class instead of a functor object. This might contain some common functionality such as the code to accumulate the minimum value and associated identifier. However I deliberately didn&#8217;t do this because it would have required a complicated interface between the base class and subclasses, for very little reuse benefit. As for readability and maintainability of the refactoring, I&#8217;d say it was a definite win.</li>
</ul>
		        <br clear="left" />
		    </div>
        </div><!-- end post -->

			
<!-- You can start editing here. -->


<div id="comments" class="post">

	<h3 class="comments_headers">1 Comment</h3>

</div>
	
	
			
        <div class="post" id="comment-1555">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Mon, 26 Feb 2007 12:37:00 -0500" />
                <abbr class="commented" title="Mon, 26 Feb 2007 12:37:00 -0500">26 February 2007 @ 12pm</abbr><br />
                <a href="#comment-1555">#</a></p>
			</div>
			<div class="content">
				<p>I forgot to point out the size of the executable: 29K, including symbols. Having experienced C++ code bloat on many occasions this was a pleasant surprise and a testament to the compiler (gcc 4.0).</p> 
							</div>
		<br clear="left" />
		</div>
		
	

	<!-- Comment Form -->

	    

			
				
<div class="posttopline">
	<span class="previous">&larr; <a href="http://girtby.net/archives/2007/02/18/my-password-safety-technique-is-unbreakable/" rel="prev">My Password Safety Technique Is Unbreakable</a></span>
	<span class="next"><a href="http://girtby.net/archives/2007/03/09/c-1-unicode-0/" rel="next">C++ 1, Unicode 0</a> &rarr;</span>
</div>

<br clear="all" />

    <div class="footer">
		
        <div class="first">
        <div id="text-318154731" class="widget widget_text"><h5 class="widgettitle">Archives</h5>			<div class="textwidget"><ul>
<li><a href="/archives/2009">2009</a></li>
<li><a href="/archives/2008">2008</a></li>
<li><a href="/archives/2007">2007</a></li>
<li><a href="/archives/2006">2006</a></li>
<li><a href="/archives/2005">2005</a></li>
<li><a href="/archives/2004">2004</a></li>
</ul></div>
		</div>		</div>

        <div class="sidebar">
        <div id="text-326846052" class="widget widget_text"><h5 class="widgettitle">Leveraged Synergy</h5>			<div class="textwidget"><p>Hello, I&#8217;m Alastair Rankine. I once had a blog, and you've found it. <a href="/about/">Would you like to know more?</a></p>
<p>From time to time I made offerings to the internet. <a href="/offerings/">Would you like some?</a></p>
</div>
		</div>        </div>

        <div class="last">
        <div id="linkcat-2" class="widget widget_links"><h5 class="widgettitle">Blogroll</h5>
	<ul class='xoxo blogroll'>
<li><a href="http://bjkeefe.blogspot.com">bjkeefe</a></li>
<li><a href="http://brainsnorkel.com">brainsnorkel</a></li>
<li><a href="http://deadlybloodyserious.com">Deadly Bloody Serious</a></li>
<li><a href="http://blog.alphajuliet.com/">follicle</a></li>
<li><a href="http://madbean.com/">madbean</a></li>
<li><a href="http://marxyblog.blogspot.com">marxy&#8217;s musing on technology</a></li>
<li><a href="http://mattrubinstein.com.au">mattrubinstein.com.au</a></li>
<li><a href="http://somethinkodd.com/oddthinking">OddThinking</a></li>

	</ul>
</div>
        </div>

	    </div><!-- end footer -->

        <br clear="all" />
        
		<div class="copyright">
        	        	<span class="previous">&larr; <a href="http://girtby.net">Back to Home</a></span>
                        <p>Powered by <a href="http://wordpress.org">WordPress</a> using the <a href="http://powazek.com/posts/516">DePo Clean Theme</a> <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/au/"><img alt="Creative Commons License" class="badge" width=80 height=15 src="http://i.creativecommons.org/l/by-sa/2.5/au/80x15.png" /></a></p>
            		</div>

	</div> <!-- end container -->
</body>
</html>
