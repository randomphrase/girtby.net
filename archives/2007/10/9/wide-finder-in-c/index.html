<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>girtby.net &#8211;   Wide Finder in C++</title>

<meta name="verify-v1" content="unGvQ7Jwj5liZb2PzH2ckduvpe8Ua3Ls0MONzCHQQn4=" />

<link rel="stylesheet" href="http://girtby.net/wp-content/themes/depo-clean/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Articles Feed" href="http://girtby.net/feed/atom/" />
<link rel="alternate" type="application/atom+xml" title="girtby.net Comments Feed" href="http://girtby.net/comments/feed/atom/" />

<link rel="openid.server" href="http://www.myopenid.com/server" />
<link rel="openid.delegate" href="http://arankine.myopenid.com/" />

<link rel="meta" href="http://girtby.net/labels.rdf" type="application/rdf+xml" title="ICRA labels" />
<meta http-equiv="pics-Label" content='(pics-1.1 "http://www.icra.org/pics/vocabularyv03/" l gen true for "http://girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1) gen true for "http://www.girtby.net" r (n 0 s 0 v 0 l 2 oa 0 ob 0 oc 0 od 0 oe 0 of 0 og 0 oh 0 c 1))' />

<link rel="prev" href="http://girtby.net/archives/2007/10/09/blog-post/" />
<link rel="next" href="http://girtby.net/archives/2007/10/09/easier-than-stealing/" />

<link rel="pingback" href="http://girtby.net/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Feed" href="http://girtby.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Comments Feed" href="http://girtby.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="girtby.net &raquo; Wide Finder in C++ Comments Feed" href="http://girtby.net/archives/2007/10/09/wide-finder-in-c/feed/" />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js'></script>
<script type='text/javascript' src='http://girtby.net/wp-content/themes/depo-clean/javascript/friendly_dates.js?ver=2.9-rare'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://girtby.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://girtby.net/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='girtby.net' href='http://girtby.net' />
<link rel='start' title='Thunderbirds Are Go-ne' href='http://girtby.net/archives/2004/09/20/thunderbirds-are-go-ne/' />
<link rel='prev' title='Blog Post' href='http://girtby.net/archives/2007/10/09/blog-post/' />
<link rel='next' title='Easier Than Stealing' href='http://girtby.net/archives/2007/10/09/easier-than-stealing/' />
<meta name="generator" content="WordPress 2.9-rare" />
<link rel='canonical' href='http://girtby.net/archives/2007/10/09/wide-finder-in-c/' />
			<script type="text/javascript" src="http://girtby.net/wp-content/plugins/flickr-tag/js/flickrTagTooltips.js"></script>

			<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTagTooltips.css" type="text/css" rel="stylesheet"/>
	
		<link href="http://girtby.net/wp-content/plugins/flickr-tag/css/flickrTag.css" type="text/css" rel="stylesheet"/>
	</head>
<body>
<div class="container">
	<div class="header">
        <div class="search">
            <form method="get" id="sform" action="http://girtby.net/">
                <input type="text" id="q" value="" name="s" size="15" />
			</form>
        </div><!-- end search -->
        			        <h1><a href="http://girtby.net/">this blog is girtby.net</a> 
            </h1>
	</div><!-- end header -->


<div class="blogads">

<!-- Your Stuff Here -->

</div>


    						
      <div class="post">
          <div class="metainfo">
              <p>Posted<br />
                <abbr class="published" title="Tue, 09 Oct 2007 11:07:00 -0400">9 October 2007 @ 11am</abbr></p>
                <p>Tagged<br />
                <a href="http://girtby.net/archives/category/nerd-factor-x/" title="View all posts in Nerd Factor X" rel="category tag">Nerd Factor X</a></p>
                <p>Tags<br/><a href="http://girtby.net/archives/tag/benchmark/" rel="tag">benchmark</a>, <a href="http://girtby.net/archives/tag/boost/" rel="tag">boost</a>, <a href="http://girtby.net/archives/tag/c/" rel="tag">c++</a>, <a href="http://girtby.net/archives/tag/wide-finder/" rel="tag">wide finder</a></p>		    </div>
		    <div class="content">
		        <h3>Wide Finder in C++ 
		        </h3>
		        <p>Have you been following Tim Bray&#8217;s <a href="http://www.tbray.org/ongoing/When/200x/2007/09/20/Wide-Finder">Wide Finder project</a>? It&#8217;s an exercise to express a fairly simple task in a manner that will scale across multiple CPU cores. Some of Tim&#8217;s initial progress with Erlang, and other contributors in different languages, is quite fascinating.</p>

<p><a href="http://www.tbray.org/ongoing/When/200x/2007/10/01/WF-Roundup">Like Tim</a> I was also amused at <a href="http://www.tincancamera.com/blog/2007/09/wide-finder-parallelism-and-languages.html">Pete Kirkham&#8217;s C++ implementation </a> which was purported to be shorter than an initial attempt by an Erlang expert (in Erlang obviously). However on closer examination it seems that Pete&#8217;s C++ implementation was simply handling the I/O portion with simplified parsing and not the subsequent sorting.</p>

<p>So as <a href="/archives/2007/2/26/kata-four-in-c">another</a> C++ coding Kata I decided to have a go. Whereas Tim&#8217;s goal was to evaluate different methods of expressing algoritms for parallel computation, mine was a lot more modest: just get it running concisely in C++ and compare performance with the raw Ruby version. Here&#8217;s what I came up with.</p>

<p><span id="more-2047"></span></p>

<pre class="htmlize">
<span class="preprocessor">#include</span> <span class="string">&lt;iostream&gt;</span>
<span class="preprocessor">#include</span> <span class="string">&lt;boost/iostreams/device/mapped_file.hpp&gt;</span>
<span class="preprocessor">#include</span> <span class="string">&lt;boost/regex.hpp&gt;</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="constant">std</span>;

<span class="keyword">const</span> <span class="constant">boost</span>::<span class="type">regex</span> <span class="function-name">get_re</span>(<span class="string">"GET /ongoing/When/\\d{3}x/(\\d{4}/\\d{2}/\\d{2}/[^ .]+) "</span>);

<span class="keyword">typedef</span> <span class="type">map</span>&lt;<span class="type">string</span>, <span class="type">unsigned</span>&gt; <span class="type">counts_by_key_t</span>;
<span class="keyword">typedef</span> <span class="type">multimap</span>&lt;<span class="type">unsigned</span>, <span class="type">string</span>&gt; <span class="type">keys_by_count_t</span>;

<span class="type">int</span> <span class="function-name">main</span>(<span class="type">int</span> <span class="variable-name">argc</span>, <span class="type">char</span> *<span class="variable-name">argv</span>[])
{
  <span class="type">counts_by_key_t</span> <span class="variable-name">counts_by_key</span>;
  <span class="keyword">for</span>(<span class="type">int</span> <span class="variable-name">arg</span> = 1; arg &lt; argc; ++arg) {
    <span class="keyword">try</span> {
      <span class="constant">boost</span>::<span class="constant">iostreams</span>::<span class="type">mapped_file_source</span> <span class="variable-name">mf</span>(<span class="type">argv</span>[arg]);

      <span class="constant">boost</span>::<span class="type">cregex_iterator</span> <span class="variable-name">regi</span>(mf.begin(), mf.end(), get_re), <span class="variable-name">rege</span>;
      <span class="keyword">for</span>(; regi != rege; ++regi) {
        counts_by_key[(*regi)[1].str()] += 1;
      }
    } <span class="keyword">catch</span> (<span class="constant">ios</span>::<span class="type">failure</span> <span class="variable-name">e</span>) {
      cerr &lt;&lt; argv[arg] &lt;&lt; <span class="string">": "</span> &lt;&lt; e.what() &lt;&lt; endl;
      <span class="keyword">return</span> 1;
    }
  }

  <span class="type">keys_by_count_t</span> <span class="variable-name">keys_by_count</span>;
  <span class="keyword">for</span>(<span class="constant">counts_by_key_t</span>::<span class="type">const_iterator</span> <span class="variable-name">i</span> = counts_by_key.begin();
      i != counts_by_key.end(); ++i) {
    keys_by_count.insert(make_pair(i-&gt;second, i-&gt;first));
  }

  <span class="type">unsigned</span> <span class="variable-name">n</span> = 10;
  <span class="keyword">for</span>(<span class="constant">keys_by_count_t</span>::<span class="type">reverse_iterator</span> <span class="variable-name">ri</span> = keys_by_count.rbegin();
      n &amp;&amp; ri != keys_by_count.rend(); ++ri, --n) {

    cout &lt;&lt; ri-&gt;first &lt;&lt; <span class="string">": "</span> &lt;&lt; ri-&gt;second &lt;&lt; endl;
  }
  <span class="keyword">return</span> 0;
}
</pre>

<p>So at 42 lines this one really <em>is</em> shorter than the 84-line Erlang version. Not a million miles away from the Ruby version either, in length if not in readability. However, I&#8217;ve made some simplifications, or taken some liberties, depending on your point of view:</p>

<ul>
<li><p>Firstly, Boost is a third-party library and hence this is not standard C++. Given the (general) difficulty of incorporating libraries into C++ apps this might be more of a problem than on other languages where CPAN/RubyForge/CheeseShop/whatever rules supreme. However I would argue that Boost is such an indispensable part of modern C++ development that relying on it is quite acceptable, even for tasks like this.</p></li>
<li><p>Also, I&#8217;m using Boost&#8217;s <code>mapped_file_stream</code>, which uses a memory map to iterate through the file. This is very useful and quick but obviously places limits on the size of the file. Fortunately it handles oversize files gracefully.</p></li>
<li><p>That <code>reverse_iterator</code> should be a <code>const_reverse_iterator</code>, but I had to work around a <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=11729">gcc bug</a>.</p></li>
<li><p>C++ generic programming purists may be scoffing at my explicit iteration through the containers. Try as I might I could not formulate a way of using the standard algorithms without signficantly increasing the complexity of the code. Inverting the <code>counts_by_key</code> map to create the <code>keys_by_count</code> multimap sounds particularly like the sort of thing that should be possible using the standard algorithms, but I was unable to work it out.</p></li>
</ul>

<p>Removing the explicit iteration may prove to be a useful exercise, in order to get better parallelization. I can picture a class of STL algorithms which are smart enough to automatically distribute work amongst different worker threads, coordinate their shared state, etc. A <code>parallel_for_each</code> algorithm perhaps. Fully utilising existing algorithms such as <code>for_each</code> seems like a necessary first step towards this goal.</p>

<p>My other goal with this was to look at performance. The C++ version above processes the 200MB file in about <strong>4.5 seconds</strong> on my laptop (running WinXP, code compiled with MSVC++ 8.0).</p>

<p>By comparison the Ruby version runs in <strong>5.0 seconds</strong>. This is pretty damn impressive if you ask me, given that it&#8217;s <em>not</em> using memory-mapped IO.</p>

<p>For an encore I would like to convert the code above to use regular file I/O. An initial attempt to use the <code>file_iterator</code> class (from the Spirit library, also part of Boost) was not hopeful; boosting the runtime up to 30 seconds. I also looked at using the standard C++ iostream iterators but the regex matching needs bidirectional iterators, and they aren&#8217;t.</p>

<p>Oh, and don&#8217;t blame me that the code isn&#8217;t <a href="/archives/2007/3/9/c-1-unicode-0">unicode safe</a>. That was part of the brief!</p>
		        <br clear="left" />
		    </div>
        </div><!-- end post -->

			
<!-- You can start editing here. -->


<div id="comments" class="post">

	<h3 class="comments_headers">4 Comments</h3>

</div>
	
	
			
        <div class="post" id="comment-1629">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://hircus.wordpress.com/2007/10/16/wide-finder-c-update/' rel='external nofollow' class='url'>Michel S.</a><br />
                <input type="hidden" name="post_date" value="Tue, 09 Oct 2007 11:07:00 -0400" />
                <abbr class="commented" title="Tue, 09 Oct 2007 11:07:00 -0400">9 October 2007 @ 11am</abbr><br />
                <a href="#comment-1629">#</a></p>
			</div>
			<div class="content">
				<p>Hi Alastair,</p>

<p>Did a similar implementation in C++, but without the multimap &#8212; slower than Ruby in the single-thread case, and on par in speed (but with higher CPU usage) with 2 and 4 threads, on a dual-core machine.</p>

<p>I guess C++ is not the language for string processing.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1630">
		    <div class="metainfo">
                <p>Posted by<br />Richard A<br />
                <input type="hidden" name="post_date" value="Tue, 09 Oct 2007 11:07:00 -0400" />
                <abbr class="commented" title="Tue, 09 Oct 2007 11:07:00 -0400">9 October 2007 @ 11am</abbr><br />
                <a href="#comment-1630">#</a></p>
			</div>
			<div class="content">
				<p>Tim has started collecting results on each WF implementation on his new toy Sun server (<a href="http://www.tbray.org/ongoing/When/200x/2007/10/30/WF-Results">http://www.tbray.org/ongoing/When/200x/2007/10/30/WF-Results</a>), but it seems he hasn&#8217;t/can&#8217;t yet run C++ programs such as yours on this highly minimal platform. Is there anything you can do to help out with this? Is it a problem with building Boost? I&#8217;d like to see how the C++ version does against the various speed demons in that table&#8230;</p>

<p>Regarding the explicit iterator usage, you <strong>might</strong> be able to use boost::lambda or boost::bind to keep the code terse (i.e. through the _1 macros), but doing that might just increase the portability problems.</p>

<p>As far as regex performance goes, C++ is only limited here by the implementation used &#8211; there&#8217;s no silver bullet to the functions in Ruby (or Perl, for that matter). There&#8217;s no good reason why you couldn&#8217;t simply embed calls to either of these languages regex handlers in a C++ program to get the best of both worlds.</p>

<p>One question I have is does the app perform any better if the sorting is done after the filtering is completed? Theoretically, the code needs a global lock on the map before writing new results to it, since two threads may try to increase a count from 0 (not in the map) to 1 simultaneously. Additionally, once there&#8217;s already a key in the map, that key&#8217;s entry should be locked for incrementing beyond 1. That would make it a major bottleneck in any multithreaded system. I&#8217;m pretty sure the target platform&#8217;s atomic int behaviour won&#8217;t save you here (since for expressions like i = i + 1, that&#8217;s just for the read(i) and write(i), not the whole expression). Don&#8217;t even think about making this a multiprocess system without some fundamental restructuring&#8230;</p>

<p>That said, I can imagine a sophisticated compiler and library that can automatically determine which data structures can be in which process, and how each would be isolated from the other. Similar (but simpler!) analysis already leads to the inlining and escape analysis done for heap to stack object conversions in some virtual machine-based languages.</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1631">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Tue, 09 Oct 2007 11:07:00 -0400" />
                <abbr class="commented" title="Tue, 09 Oct 2007 11:07:00 -0400">9 October 2007 @ 11am</abbr><br />
                <a href="#comment-1631">#</a></p>
			</div>
			<div class="content">
				<p>Excellent comments Richard.</p>

<p>I have been waiting to see if Tim gets to give my code a run on his 8-core box. For the record, I&#8217;m not expecting much; as I said above, my implementation was mainly about conciseness and readability, not performance.</p>

<p>I did look at boost::lambda and boost::bind but, like I said, they didn&#8217;t do anything for readability or conciseness. Quite happy to admit operator error though; I haven&#8217;t had much experience with boost::lambda.</p>

<p>I&#8217;ve thought a bit about performance lately, particularly in light of <a href="/archives/2007/11/6/required-viewing">recently-acquired knowledge</a>, and would like to tinker some more in this space. A couple of optimisations have presented themselves, mainly as a result of reading about other attempts, particularly the interesting <a href="http://effbot.org/zone/wide-finder.htm">python implementation</a>.</p>

<p>One thing that the python implementation does is to filter the input lines using a non-regex search first. This allows the classic Boyer-Moore (or whatever) string search algorithms to kick in, which are apparently a lot more efficient than a regex search. I see no reason why I couldn&#8217;t do the same in my implementation, just using <code>std::search</code> even!</p>

<p>Parallelizing the code is more tricky, obviously, but the same techniques would apply here as with the python implementation: chunk the input and process it in multiple threads. Again, no real obstacle to adapt this to my code.</p>

<p>There is no need to synchronise writes to the <code>counts_by_key</code> map &#8211; just give each thread a local copy of the map. You need to synchronise the writes to the <code>keys_by_count</code> multimap of course, but again maybe a thread-local multimap might be the way to go, prior to a final non-parallel aggregation step? Something to think about anyway. Like you I have some doubts as to whether there would be any practical benefit here? (Again, Herb Sutter&#8217;s memory latency talk is looming large)</p> 
							</div>
		<br clear="left" />
		</div>
			
        <div class="post" id="comment-1632">
		    <div class="metainfo">
                <p>Posted by<br /><a href='http://girtby.net' rel='external nofollow' class='url'>Alastair</a><br />
                <input type="hidden" name="post_date" value="Tue, 09 Oct 2007 11:07:00 -0400" />
                <abbr class="commented" title="Tue, 09 Oct 2007 11:07:00 -0400">9 October 2007 @ 11am</abbr><br />
                <a href="#comment-1632">#</a></p>
			</div>
			<div class="content">
				<blockquote>
  <p>I see no reason why I couldn</p>
</blockquote> 
							</div>
		<br clear="left" />
		</div>
		
	

	<!-- Comment Form -->

	    

			
				
<div class="posttopline">
	<span class="previous">&larr; <a href="http://girtby.net/archives/2007/10/09/blog-post/" rel="prev">Blog Post</a></span>
	<span class="next"><a href="http://girtby.net/archives/2007/10/09/easier-than-stealing/" rel="next">Easier Than Stealing</a> &rarr;</span>
</div>

<br clear="all" />

    <div class="footer">
		
        <div class="first">
        <div id="text-318154731" class="widget widget_text"><h5 class="widgettitle">Archives</h5>			<div class="textwidget"><ul>
<li><a href="/archives/2009">2009</a></li>
<li><a href="/archives/2008">2008</a></li>
<li><a href="/archives/2007">2007</a></li>
<li><a href="/archives/2006">2006</a></li>
<li><a href="/archives/2005">2005</a></li>
<li><a href="/archives/2004">2004</a></li>
</ul></div>
		</div>		</div>

        <div class="sidebar">
        <div id="text-326846052" class="widget widget_text"><h5 class="widgettitle">Leveraged Synergy</h5>			<div class="textwidget"><p>Hello, I&#8217;m Alastair Rankine. I once had a blog, and you've found it. <a href="/about/">Would you like to know more?</a></p>
<p>From time to time I made offerings to the internet. <a href="/offerings/">Would you like some?</a></p>
</div>
		</div>        </div>

        <div class="last">
        <div id="linkcat-2" class="widget widget_links"><h5 class="widgettitle">Blogroll</h5>
	<ul class='xoxo blogroll'>
<li><a href="http://bjkeefe.blogspot.com">bjkeefe</a></li>
<li><a href="http://brainsnorkel.com">brainsnorkel</a></li>
<li><a href="http://deadlybloodyserious.com">Deadly Bloody Serious</a></li>
<li><a href="http://blog.alphajuliet.com/">follicle</a></li>
<li><a href="http://madbean.com/">madbean</a></li>
<li><a href="http://marxyblog.blogspot.com">marxy&#8217;s musing on technology</a></li>
<li><a href="http://mattrubinstein.com.au">mattrubinstein.com.au</a></li>
<li><a href="http://somethinkodd.com/oddthinking">OddThinking</a></li>

	</ul>
</div>
        </div>

	    </div><!-- end footer -->

        <br clear="all" />
        
		<div class="copyright">
        	        	<span class="previous">&larr; <a href="http://girtby.net">Back to Home</a></span>
                        <p>Powered by <a href="http://wordpress.org">WordPress</a> using the <a href="http://powazek.com/posts/516">DePo Clean Theme</a> <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/au/"><img alt="Creative Commons License" class="badge" width=80 height=15 src="http://i.creativecommons.org/l/by-sa/2.5/au/80x15.png" /></a></p>
            		</div>

	</div> <!-- end container -->
</body>
</html>
